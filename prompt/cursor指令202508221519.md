好的，下面是**给 cursor 的本地工单**。你把这一整条消息保存成 `CURSOR_TASK_LOCAL.md` 让他照做即可；其中含有**一键脚本**、**Makefile 目标**、**配置补丁**和**失败上报清单**。所有命令均为**可直接复制执行**，并内置**断点续训**与**日志留存/报错上报**机制。

---

# **给 cursor 的工单（本地）**

**主题：RC1 开跑前“二轮预检 \+ 断点续训 \+ 报错上报”全流程**

## **0\) 强制规则（必须遵守）**

* **严禁**在预检未通过时启动训练；只有当 `reports/preflight/round2_pass.json` 存在时才可执行训练。  
* **任何报错立刻停止**并上报（见文末“失败上报清单”）；不得私自改指标、删日志。  
* **全部命令在仓库根目录执行**；若命令提示文件不存在，就按“需要你创建的文件与脚本”一节创建。

---

## **1\) 一键脚本（创建并运行）**

把下面内容粘贴为 `ops/run_local_rc1.sh`（如无 `ops/` 目录先创建），然后执行：

mkdir \-p ops && nano ops/run\_local\_rc1.sh  
\# 粘贴完毕后：  
chmod \+x ops/run\_local\_rc1.sh  
./ops/run\_local\_rc1.sh

**`ops/run_local_rc1.sh` 内容：**

\#\!/usr/bin/env bash  
set \-euo pipefail

\# \============ 基本环境 \============  
export PYTHONUNBUFFERED=1  
export RUN\_MODE=prod  
export BASE\_MODEL="${BASE\_MODEL:-Qwen/Qwen3-4B-Thinking-2507}"  
export SCORER\_PROVIDER="${SCORER\_PROVIDER:-gemini}"   \# 可选：gemini / deepseek\_r1 / openai 等  
: "${SCORER\_API\_KEY:?请先 export SCORER\_API\_KEY=你的真实Key}"

\# 目录就绪  
mkdir \-p logs reports/preflight reports/rc1 data/rollouts checkpoints/rc1/best templates/pack\_v2

\# 全局日志管道：所有 stdout/stderr 进入总日志 \+ 局部日志  
exec \> \>(tee \-a "logs/ops\_$(date \+%Y%m%d\_%H%M%S).log") 2\>&1

\# 错误陷阱：一旦出错，打包关键信息用于上报  
on\_error () {  
  echo "🚨 发生错误，正在收集最后200行日志与关键产物……"  
  tail \-n 200 logs/\*.log || true  
  tar \-czf "reports/rc1/FAIL\_$(date \+%Y%m%d\_%H%M%S).tgz" \\  
    logs \\  
    reports/preflight || true  
  echo "❌ 失败归档已生成：reports/rc1/FAIL\_\*.tgz"  
}  
trap on\_error ERR

\# \============ 1\. Python 环境与依赖 \============  
if \! command \-v python3 \>/dev/null; then echo "❌ 缺少 python3"; exit 2; fi  
PYVER=$(python3 \- \<\<'PY'  
import sys  
print(f"{sys.version\_info.major}.{sys.version\_info.minor}")  
PY  
)  
echo "Python version: $PYVER"  
python3 \-m venv .venv  
source .venv/bin/activate  
python \-m pip install \-U pip wheel  
if \[ \-f requirements.txt \]; then  
  pip install \-r requirements.txt  
else  
  \# 最低依赖兜底（按项目需要增补）  
  pip install "torch\~=2.3" "transformers\>=4.42" "datasets\>=2.19" \\  
              "trl\>=0.9" "peft\>=0.11" "accelerate\>=0.33" "evaluate\>=0.4" \\  
              "tqdm" "numpy" "scikit-learn" "pyyaml" "jsonlines" "jinja2"  
fi

\# \============ 2\. Git 指纹（可审计） \============  
git rev-parse \--is-inside-work-tree \>/dev/null 2\>&1 && {  
  git status \--porcelain \> reports/rc1/git\_status.txt || true  
  git rev-parse HEAD \> reports/rc1/git\_commit.txt || true  
}

\# \============ 3\. 资源检查 \============  
python \- \<\<'PY'  
import shutil, os  
free\_gb \= shutil.disk\_usage(".").free/2\*\*30  
assert free\_gb\>50, f"磁盘不足：{free\_gb:.1f}GB，至少需\>50GB"  
print(f"DISK\_OK {free\_gb:.1f}GB 可用")  
PY

\# \============ 4\. 评分器真连通 \+ 防模拟 \============  
\# 4.1 探针：必须有真实延迟与可计费调用  
python scripts/probe\_scorer.py \--n 8 \--provider "$SCORER\_PROVIDER" \--live

\# 4.2 防伪：缓存命中率首轮必须 \< 90%  
python scripts/assert\_not\_simulated.py \--cache\_hit\_lt 0.90

\# \============ 5\. 影子评测集物化 \============  
python \-m src.evaluation.shadow\_run \--n 245 \--seed 20250820 \--stratify \\  
  \--materialize data/shadow\_eval\_245.jsonl \\  
  \--dump-manifest reports/rc1/sample\_manifest.json  
sha256sum data/shadow\_eval\_245.jsonl \> reports/rc1/shadow\_eval\_245.sha256

\# \============ 6\. 构建种子池（按需调整n与配比） \============  
python scripts/build\_rollout\_pool.py \\  
  \--out data/rollouts/rc1\_seed.jsonl \\  
  \--n 30000 \\  
  \--mix "hotpotqa:0.45,strategyqa:0.30,gsm8k:0.25" \\  
  \--max\_turns 6 \--clarify\_rate 0.30 \\  
  \--tools "wiki,calc" \\  
  \--templates\_dir templates/pack\_v2

\# \============ 7\. 多样性体检（扩量前闸门） \============  
python scripts/validate\_pool.py data/rollouts/rc1\_seed.jsonl \\  
  \--min\_distinct2 0.60 \--kl3\_min 0.15 \--roles\_min 4 \--styles\_min 3 \\  
  \--max\_dup\_pct 2.0 \--max\_len 4096 \--min\_len 64 \\  
  \--leak\_check data/shadow\_eval\_245.jsonl \--leak\_ngram 5 \--leak\_sim 0.85 \\  
  \--by\_task "hotpotqa,strategyqa,gsm8k"  
sha256sum data/rollouts/rc1\_seed.jsonl \> reports/rc1/rc1\_seed.sha256

\# \============ 8\. 难度指标 → 分桶 → 平衡分布 \============  
python scripts/difficulty\_metrics.py \\  
  \--in data/rollouts/rc1\_seed.jsonl \\  
  \--out data/rollouts/rc1\_seed.metrics.jsonl

python scripts/difficulty\_bucketize.py \\  
  \--metrics data/rollouts/rc1\_seed.metrics.jsonl \\  
  \--target "easy:0.25,medium:0.45,hard:0.30" \\  
  \--by\_task "hotpotqa,strategyqa,gsm8k" \\  
  \--out data/rollouts/rc1\_seed.balanced.jsonl

python scripts/validate\_difficulty.py \\  
  \--metrics data/rollouts/rc1\_seed.metrics.jsonl \\  
  \--balanced data/rollouts/rc1\_seed.balanced.jsonl \\  
  \--min\_hard\_pct 0.30 \--max\_easy\_pct 0.30 \\  
  \--len\_max 3500 \--turns\_max 8 \--tool\_hops\_max 8 \\  
  \--clue\_overlap\_max\_easy 0.65 \--clue\_overlap\_min\_hard 0.10 \\  
  \--out reports/rc1/difficulty\_report.json

sha256sum data/rollouts/rc1\_seed.metrics.jsonl \> reports/rc1/rc1\_seed.metrics.sha256  
sha256sum data/rollouts/rc1\_seed.balanced.jsonl \> reports/rc1/rc1\_seed.balanced.sha256

\# \============ 9\. 权重文件与惩罚开关体检 \============  
test \-f configs/weights.json || (echo "缺少 configs/weights.json" && exit 2\)  
python \- \<\<'PY'  
import json,hashlib  
w=json.load(open("configs/weights.json"))  
wsum=sum(w\["weights"\].values())  
assert abs(wsum-1.0)\<1e-6, "weights 未归一化"  
assert max(w\["weights"\].values())\<=0.5+1e-9, "存在单维\>0.5"  
assert all(v\>=0 for v in w\["weights"\].values()), "出现负权重"  
print("WEIGHTS\_OK",hashlib.sha256(open("configs/weights.json","rb").read()).hexdigest())  
PY

grep \-q "use\_overclar\_penalty: true" configs/ppo\_scale.yaml || (echo "未启用过度澄清惩罚(use\_overclar\_penalty)" && exit 2\)  
pytest \-q tests/test\_overclar\_penalty.py

\# \============ 10\. Round 1 报告聚合 \============  
python \- \<\<'PY'  
import json,hashlib,datetime  
def sha(p):  
  import pathlib,hashlib  
  try: return hashlib.sha256(open(p,"rb").read()).hexdigest()  
  except: return None  
r={"round":"round1","ts":datetime.datetime.utcnow().isoformat()+"Z","pass":True}  
r\["files"\]={  
  "shadow\_eval":"data/shadow\_eval\_245.jsonl",  
  "shadow\_eval\_sha":sha("data/shadow\_eval\_245.jsonl"),  
  "seed\_pool":"data/rollouts/rc1\_seed.jsonl",  
  "seed\_pool\_sha":sha("data/rollouts/rc1\_seed.jsonl"),  
  "seed\_pool\_balanced":"data/rollouts/rc1\_seed.balanced.jsonl",  
  "seed\_pool\_balanced\_sha":sha("data/rollouts/rc1\_seed.balanced.jsonl"),  
  "weights":"configs/weights.json",  
  "ppo\_cfg":"configs/ppo\_scale.yaml",  
}  
open("reports/preflight/round1.json","w").write(json.dumps(r,indent=2))  
print("PRE-R1-REPORT: reports/preflight/round1.json")  
PY

\# \============ 11\. Round 2 复核（更接近实战口径） \============  
\# 11.1 防伪：缓存命中阈值放宽到 \<95%  
python scripts/assert\_not\_simulated.py \--cache\_hit\_lt 0.95

\# 11.2 以当前权重/惩罚口径再跑一次影子检查（带 tag）  
python \-m src.evaluation.shadow\_run \--n 245 \--seed 20250820 \--stratify \--tag "pre\_run\_check"

\# 11.3 生成 Round 2 通过票  
python \- \<\<'PY'  
import json,datetime,os  
r={"round":"round2","ts":datetime.datetime.utcnow().isoformat()+"Z","pass":True}  
open("reports/preflight/round2\_pass.json","w").write(json.dumps(r,indent=2))  
print("PRE-R2-REPORT: reports/preflight/round2\_pass.json")  
PY

\# \============ 12\. 只有通过后才允许启动训练 \============  
test \-f reports/preflight/round2\_pass.json || (echo "预检未通过：禁止开跑" && exit 2\)

\# 接入难度感知采样  
if \! grep \-q 'seed\_pool: "data/rollouts/rc1\_seed.balanced.jsonl"' configs/ppo\_scale.yaml; then  
  echo "⚠️ 你尚未将 balanced 种子池写入 configs/ppo\_scale.yaml：seed\_pool: \\"data/rollouts/rc1\_seed.balanced.jsonl\\""  
  echo "⚠️ priority\_sampling.by\_difficulty 建议 {easy:0.2, medium:0.4, hard:0.4}"  
fi

\# 训练启动（断点续训：如需恢复，加 \--resume-from checkpoints/rc1/latest ）  
python \-m train.ppo\_runner \--config configs/ppo\_scale.yaml | tee \-a logs/train.log

---

## **2\) 需要你创建的文件与脚本（若仓库没有）**

若以下脚本/测试文件在仓库中不存在，请新建对应空位或按需实现。**命名与路径必须一致**，以便一键脚本可直接调用。

1. **难度相关脚本**  
* `scripts/difficulty_metrics.py`  
* `scripts/difficulty_bucketize.py`  
* `scripts/validate_difficulty.py`

这些脚本应完成：从样本中抽取难度特征（长度、轮次、工具跳数、实体数、数值运算步、连接词密度、clue\_overlap 等），输出 `*.metrics.jsonl`；按目标分布重采样生成 `rc1_seed.balanced.jsonl`；并在 `validate_difficulty.py` 中校验分布（Hard ≥30%、Easy ≤30%，并生成直方图/分位数/任务拆分计数的 `reports/rc1/difficulty_report.json`）。

2. **评分探针与防伪脚本**  
* `scripts/probe_scorer.py`：接受 `--n --provider --live`，验证**真实**打分（存在可计费调用与非零延迟）。  
* `scripts/assert_not_simulated.py`：接受 `--cache_hit_lt <阈值>`，若近期命中率 ≥ 阈值则退出 2。  
3. **影子运行与评估**  
* `src/evaluation/shadow_run.py`：支持 `--n --seed --stratify [--materialize PATH] [--tag LABEL]`；产出 `reports/shadow_run_*.json`，字段应含 `spearman, kendall_tau, top10_overlap, top20_overlap, corr_to_success_old/new, corr_improve_pct`。  
* 旧/新评分器保持并行可用；对方差\>0.08 的样本做“unstable”标记并剔除/降权。  
4. **过度澄清惩罚**  
* `tests/test_overclar_penalty.py`：覆盖 3 条用例（不触发、c=1/2/5、`needs_clarification=true`）全部通过。

在 `configs/ppo_scale.yaml` 中**必须**包含：  
use\_overclar\_penalty: true

* 训练聚合前将 `penalty = alpha * min(c, cap)` 计入主奖励（建议 `alpha=0.07, cap=3`）。

---

## **3\) 断点续训与产物留存（强约束）**

* **检查点**：训练脚本每 N step（例如 1000）保存到 `checkpoints/rc1/step_XXXXX/`；最新软链接 `checkpoints/rc1/latest`。  
* **最佳权重**：每次阶段评测通过，就复制到 `checkpoints/rc1/best/`（只增不改）。  
* **日志**：  
  * 过程日志：`logs/train.log`（`tee -a` 方式持续写入）。  
  * 指标/报告：统一落在 `reports/`（包括多样性、难度、影子运行、权重校准、消融实验）。

**恢复**：中断后用  
python \-m train.ppo\_runner \--config configs/ppo\_scale.yaml \--resume-from checkpoints/rc1/latest

*   
* **数据指纹**：所有关键 JSON/权重/配置均计算 `sha256sum` 落盘到 `reports/rc1/*.sha256`。

---

## **4\) Makefile（可选但强烈建议）**

若你使用 Make 驱动，把下面保存为 `Makefile`，方便快速执行与重复上报。

.PHONY: preflight round1 round2 train resume failpack

preflight:  
\\t./ops/run\_local\_rc1.sh

round1:  
\\tpython \-m src.evaluation.shadow\_run \--n 245 \--seed 20250820 \--stratify \--materialize data/shadow\_eval\_245.jsonl \--dump-manifest reports/rc1/sample\_manifest.json  
\\tpython scripts/build\_rollout\_pool.py \--out data/rollouts/rc1\_seed.jsonl \--n 30000 \--mix "hotpotqa:0.45,strategyqa:0.30,gsm8k:0.25" \--max\_turns 6 \--clarify\_rate 0.30 \--tools "wiki,calc" \--templates\_dir templates/pack\_v2  
\\tpython scripts/validate\_pool.py data/rollouts/rc1\_seed.jsonl \--min\_distinct2 0.60 \--kl3\_min 0.15 \--roles\_min 4 \--styles\_min 3 \--max\_dup\_pct 2.0 \--max\_len 4096 \--min\_len 64 \--leak\_check data/shadow\_eval\_245.jsonl \--leak\_ngram 5 \--leak\_sim 0.85 \--by\_task "hotpotqa,strategyqa,gsm8k"

round2:  
\\tpython scripts/assert\_not\_simulated.py \--cache\_hit\_lt 0.95  
\\tpython \-m src.evaluation.shadow\_run \--n 245 \--seed 20250820 \--stratify \--tag "pre\_run\_check"  
\\tpython \- \<\<'PY'\\nimport json,datetime; open("reports/preflight/round2\_pass.json","w").write(json.dumps({"round":"round2","ts":datetime.datetime.utcnow().isoformat()+"Z","pass":True},indent=2))\\nprint("PRE-R2-REPORT: reports/preflight/round2\_pass.json")\\nPY

train:  
\\ttest \-f reports/preflight/round2\_pass.json || (echo "预检未通过：禁止开跑" && exit 2\)  
\\tpython \-m train.ppo\_runner \--config configs/ppo\_scale.yaml | tee \-a logs/train.log

resume:  
\\ttest \-f checkpoints/rc1/latest || (echo "无 latest 检查点" && exit 2\)  
\\tpython \-m train.ppo\_runner \--config configs/ppo\_scale.yaml \--resume-from checkpoints/rc1/latest | tee \-a logs/train.log

failpack:  
\\ttar \-czf reports/rc1/FAIL\_$(shell date \+%Y%m%d\_%H%M%S).tgz logs reports/preflight || true

---

## **5\) 训练配置补丁（核对要点）**

在 `configs/ppo_scale.yaml` 中应至少包含/校验以下关键项（若无请补）：

simulate: false  
live\_mode: true  
base\_model: "Qwen/Qwen3-4B-Thinking-2507"  
seed\_pool: "data/rollouts/rc1\_seed.balanced.jsonl"  
priority\_sampling:  
  enable: true  
  by\_difficulty: {easy: 0.2, medium: 0.4, hard: 0.4}  
  low\_perf\_cap: 0.30  
  seed\_ratio\_schedule:  
    \- {step: 0, ratio: 0.50}  
    \- {step: 20000, ratio: 0.35}  
    \- {step: 40000, ratio: 0.20}  
use\_overclar\_penalty: true  
target\_kl: 0.02  \# 可在 0.02\~0.05 之间微调  
steps: 50000     \# \< 50k 拒绝开跑  
seeds: \[20250820, 20250821, 20250822\]  
finetune:  
  method: qlora

---

## **6\) 失败上报清单（出错必须回传）**

**仅当任一步骤失败时**，把以下文件打包（脚本已自动生成 tar 包）并回传给老板/架构师复盘：

* `reports/rc1/FAIL_*.tgz`（里面包含 `logs/` 与 `reports/preflight/`）  
* 以下若存在也一并附上：  
  * `data/shadow_eval_245.jsonl`（及 `*.sha256`）  
  * `data/rollouts/rc1_seed*.jsonl`（及 `*.sha256`）  
  * `reports/rc1/difficulty_report.json`  
  * `reports/shadow_run_*.json`  
  * `reports/calibration_report_*.json`、`configs/weights.json`  
  * `configs/ppo_scale.yaml`  
  * `logs/train.log`（若已启动过训练）

---

## **7\) 验收门槛（你自检项）**

* **多样性**：`distinct-2 ≥ 0.60`、`3-gram KL ≥ 0.15`、角色≥4、语体≥3；影子集**无泄漏**。  
* **难度分布**（按任务逐项核对）：Hard ≥30%，Easy ≤30%。  
* **防伪**：首轮缓存命中率 \<90%，复核 \<95%；探针显示**真实**延迟且可计费。  
* **权重文件**：存在、非负、归一、单维 ≤0.5；`use_overclar_penalty: true` 且单测通过。  
* **训练**：只有当 `reports/preflight/round2_pass.json` 存在时才可启动。

---

### **一句话总结给 cursor**

先跑 `./ops/run_local_rc1.sh`。**任何 FAIL 不许硬上**，打包 `reports/rc1/FAIL_*.tgz` 回报；**只有**生成 `reports/preflight/round2_pass.json` 后，才允许执行训练命令。

