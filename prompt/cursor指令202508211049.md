# **【新增】先把 GitHub / Hugging Face 凭证配全，再继续后续流程**

目标：在 **本地与 Colab** 两侧把所需的 API Key/Token 配好并自检，通过后再按上一版规划继续。任一步失败**立即停止并上报**。

---

## **A. 凭证与环境一次性配置（本地 \+ Colab）**

\# 0\) 安全 bash 选项  
set \-euo pipefail

\# 1\) 本地侧统一环境变量已经写进 .env  
包含`GEMINI_API_KEY / HF_TOKEN / GIT_TOKEN`

\*\*Colab 侧：\*\*在左侧 *Secrets* 新增同名键 `GEMINI_API_KEY / HF_TOKEN / GIT_TOKEN`，Notebook 中读取：

from google.colab import userdata; import os  
for k in \["GEMINI\_API\_KEY","HF\_TOKEN","GIT\_TOKEN"\]:  
    v \= userdata.get(k) or ""  
    assert v, f"Missing secret: {k}"  
    os.environ\[k\] \= v  
os.environ\["RUN\_MODE"\]="prod"; os.environ\["SCORER\_PROVIDER"\]="gemini"

---

## **B. GitHub 凭证连通性与发布权限自检**

\# 1\) 校验可调用 API（应返回 200）  
curl \-s \-H "Authorization: token $GIT\_TOKEN" https://api.github.com/user \> /dev/null

\# 2\) 在目标仓库创建/列出一个临时 Draft Release（不上传二进制）  
DRAFT\_TAG="rc1-secrets-check-$(date \+%s)"  
curl \-s \-X POST \\  
  \-H "Authorization: token $GIT\_TOKEN" \\  
  \-H "Accept: application/vnd.github+json" \\  
  https://api.github.com/repos/$GITHUB\_REPO/releases \\  
  \-d "{\\"tag\_name\\":\\"$DRAFT\_TAG\\",\\"name\\":\\"$DRAFT\_TAG\\",\\"draft\\":true}" \\  
  | jq \-r '.id,.html\_url'

\# 3\) 立即删除该 Draft（避免污染）  
REL\_ID=$(curl \-s \-H "Authorization: token $GIT\_TOKEN" https://api.github.com/repos/$GITHUB\_REPO/releases | jq '.\[0\].id')  
curl \-s \-X DELETE \-H "Authorization: token $GIT\_TOKEN" https://api.github.com/repos/$GITHUB\_REPO/releases/$REL\_ID  
echo "✅ GitHub Releases API 权限正常"

若任一步非 2xx：**立即停止**并上报错误响应体与 HTTP 状态码。

---

## **C. Hugging Face 凭证与仓库自检（公有仓）**

python \- \<\<'PY'  
import os, sys  
from huggingface\_hub import HfApi, HfFolder, create\_repo, whoami  
tok=os.environ.get("HF\_TOKEN"); assert tok, "Missing HF\_TOKEN"  
HfFolder.save\_token(tok); api=HfApi()  
me=whoami(token=tok); print("HF whoami:", me\["name"\])  
repo\_id=os.environ.get("HF\_REPO\_ID","Atomheart-Father/rc1-qwen3-4b-thinking-gemini")  
create\_repo(repo\_id, private=False, exist\_ok=True, token=tok)  
\# 上传一个占位 README 并立即删除，验证写权限  
open("README.tmp","w").write("\# rc1 tmp\\n")  
api.upload\_file(path\_or\_fileobj="README.tmp", path\_in\_repo="README.tmp", repo\_id=repo\_id, token=tok)  
api.delete\_file(path\_in\_repo="README.tmp", repo\_id=repo\_id, token=tok)  
print("✅ HF repo write-ok:", repo\_id)  
PY

---

## **D. Gemini 通道快速探针（计费+时延+账本）**

\# 清账本，跑探针 \+ 反模拟；必须“计费\>0 且 latency\>0”  
rm \-f reports/rc1/scoring\_ledger.jsonl || true  
python scripts/probe\_scorer.py \--n 6 \--provider gemini \--live  
python scripts/assert\_not\_simulated.py \--cache\_hit\_lt 0.90

\# 验收摘要（生成 gemini\_health.json）  
python \- \<\<'PY'  
import json,statistics  
rows=\[json.loads(l) for l in open("reports/rc1/scoring\_ledger.jsonl")\]  
lat=\[r.get("latency\_ms") or 0 for r in rows if r.get("latency\_ms") is not None\]  
bill=\[r.get("billable\_tokens") or 0 for r in rows\]  
out={"total":len(rows),"ok":sum(r.get("status")=="ok" for r in rows),  
     "uncached":sum(not r.get("cache\_hit",False) for r in rows),  
     "p50\_latency\_ms":statistics.median(lat) if lat else None,  
     "zero\_billable":sum(1 for b in bill if b==0)}  
open("reports/rc1/gemini\_health.json","w").write(json.dumps(out,indent=2,ensure\_ascii=False))  
print("✅ Gemini health:", out)  
PY

任一步失败**立即停止**并回报 `scoring_ledger.jsonl` 末 20 行 \+ 终端完整错误。

---

## **E. 修复模板多样性与种子池（阻断项，修好再继续）**

根因：当前 `data/rollouts/rc1_seed.jsonl` 由**低多样性模板**生成，`distinct-2/角色/语体` 严重不达标。

1. **补齐模板**（每任务 ≥6 模板，共 ≥18 个；每条模板包含 `role`/`style`/`prompt`，避免高度相似句式；变量如 `{question}`, `{tool_hint}`, `{constraints}`）  
   目录结构：

templates/pack\_v2/  
  hotpotqa/template\_01.json ... template\_06.json  
  strategyqa/template\_01.json ... template\_06.json  
  gsm8k/template\_01.json ... template\_06.json

角色建议（至少 4 种，均衡出现在三任务）：`socratic_mentor`, `contrarian_auditor`, `field_researcher`, `planner_engineer`, `teacher`, `note_taker`  
语体建议（至少 3 种）：`formal`, `concise_bullets`, `friendly`

2. **重建种子池 → 多样性/难度报告（必须达标）**

python scripts/build\_rollout\_pool.py \--out data/rollouts/rc1\_seed.jsonl \--n 30000 \\  
  \--mix "hotpotqa:0.45,strategyqa:0.30,gsm8k:0.25" \\  
  \--max\_turns 6 \--clarify\_rate 0.35 \--tools "wiki,calc" \\  
  \--templates\_dir templates/pack\_v2 \--min\_tool\_hops 3 \--ops\_numeric\_min 3 \\  
  \--role\_style\_balanced \--distinct\_prompts

python scripts/validate\_pool.py data/rollouts/rc1\_seed.jsonl \\  
  \--min\_distinct2 0.60 \--kl3\_min 0.15 \--roles\_min 4 \--styles\_min 3 \\  
  \--max\_dup\_pct 2.0 \--leak\_check data/shadow\_eval\_245.jsonl \\  
  \--leak\_ngram 5 \--leak\_sim 0.85 \> reports/rc1/diversity\_report.txt

python scripts/difficulty\_metrics.py \\  
  \--in data/rollouts/rc1\_seed.jsonl \--out data/rollouts/rc1\_seed.metrics.jsonl

python scripts/difficulty\_bucketize.py \\  
  \--metrics data/rollouts/rc1\_seed.metrics.jsonl \\  
  \--target "easy:0.25,medium:0.45,hard:0.30" \\  
  \--by\_task "hotpotqa,strategyqa,gsm8k" \\  
  \--out data/rollouts/rc1\_seed.balanced.jsonl

python scripts/validate\_difficulty.py \\  
  \--metrics data/rollouts/rc1\_seed.metrics.jsonl \\  
  \--balanced data/rollouts/rc1\_seed.balanced.jsonl \\  
  \--min\_hard\_pct 0.30 \--max\_easy\_pct 0.30 \\  
  \--len\_max 3500 \--turns\_max 8 \--tool\_hops\_max 8 \\  
  \--clue\_overlap\_max\_easy 0.65 \--clue\_overlap\_min\_hard 0.10 \\  
  \--out reports/rc1/difficulty\_report.json

echo "✅ 多样性报告（节选）:" && sed \-n '1,80p' reports/rc1/diversity\_report.txt

**若任何阈值未达标：立即停，回滚模板，继续迭代模板后重试**。严禁修改阈值。

---

## **F. 凭证就绪后，按上一版“拿 Key 后的完整清单”继续执行**

* 影子评估预检 → RC 闸门 → 2k 步小跑 → HF 全量推送 & GitHub Releases 轻量包。  
* 全程**不得**出现“演示式继续跑”。任何失败**立即停止并上报**。

