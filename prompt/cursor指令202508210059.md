收到日志。我做了快速体检：流程基本齐，但有几处**硬风险**必须立刻整改，然后再进入拿 Key 后的“真验证”。我把“问题→整改→下一步指令”一口气给全了，Cursor照抄执行即可。

# **现状复盘（从日志看出的风险）**

* 多处用了 `|| echo "失败…继续"` 的写法，在**闸门与评测阶段**不能容错继续——必须**非0退出**（否则会产出“演示性产物”污染后续）。  
* `GITHUB_REPO` 仍是占位（owner/repo），会导致 Release 上传失败。  
* 模板刚好 6 个、角色/语体 6-6，看不到**distinct-2 / 3-gram KL 的数值**证据。  
* “影子集 245”与“账本 490 条”出现在**无真实 Key**条件下生成，默认视为**无效数据**，需清空后重跑。

---

# **立刻整改（必须做，5 分钟内能完成）**

在项目根目录执行，任何一步失败必须**中止**。

**0\) 一次性设置安全 Bash 选项 \+ 环境**

set \-euo pipefail  
export RUN\_MODE=prod  
export SCORER\_PROVIDER=gemini

**1\) 禁止“演示式继续跑”**

* 搜索这些模式并移除：`|| echo "❌"`、`|| true`、`; exit 0`。  
* 在以下脚本开头加：`set -euo pipefail`  
  * `scripts/pre_run_check.py`（若为 python，保持非0退出语义）  
  * `scripts/auto_round2_check.py`  
  * `scripts/build_rollout_pool.py`（wrap 主入口）  
  * `scripts/rc1_delivery_check.py`  
  * `scripts/probe_scorer.py` / `scripts/assert_not_simulated.py` 的 shell 包装入口

**2\) 补齐发布目标（避免上传失败）**

\# 由 PM 提供真实代码仓后设置，例如：  
export GITHUB\_REPO="Atomheart-Father/llm-active-questioning"   \# \<- PM 给

* 把 Colab 推送单元/脚本里 `owner/repo` 占位统一替换为 `os.environ["GITHUB_REPO"]`（无则报错退出）。

**3\) 清理无效产物（防污染）**

rm \-f reports/rc1/scoring\_ledger.jsonl || true  
rm \-f reports/preflight/round1.json reports/preflight/round2\_pass.json || true  
rm \-f data/shadow\_eval\_245.jsonl || true

**4\) 模板自检（必须出“数值”）**

python scripts/validate\_pool.py data/rollouts/rc1\_seed.jsonl \\  
  \--min\_distinct2 0.60 \--kl3\_min 0.15 \--roles\_min 4 \--styles\_min 3 \\  
  \--max\_dup\_pct 2.0 \--dry\_run\_only \\  
  \> reports/rc1/template\_diversity\_check.txt

这一步只读模板并输出 distinct-2 / KL **实际分数**到文件，便于我复核。

提交以上修复：

git add . && git commit \-m "fix: enforce hard-fail preflight, require GITHUB\_REPO env, purge invalid demo artifacts, add numeric diversity report" && git push

---

# **拿到真实 Gemini Key 后：一次性执行清单**

下面每步都**必须 PASS** 才能进入下一步；任一失败立即停。

**A. 配好 Secrets（Colab 或本地）**

\# Colab Secrets: GEMINI\_API\_KEY / HF\_TOKEN / GIT\_TOKEN  
python scripts/probe\_scorer.py \--n 6 \--provider gemini \--live  
python scripts/assert\_not\_simulated.py \--cache\_hit\_lt 0.90

**B. 固化影子集 \+ 预检（必须非0失败时中止）**

python \-m src.evaluation.shadow\_run \--n 245 \--seed 20250820 \--stratify \\  
  \--materialize data/shadow\_eval\_245.jsonl \\  
  \--dump-manifest reports/rc1/sample\_manifest.json

python scripts/pre\_run\_check.py \--shadow data/shadow\_eval\_245.jsonl \\  
  \--spearman-min 0.55 \--top10-min 0.60

**C. 重建 30k 种子池 \+ 多样性/难度全量报告**

python scripts/build\_rollout\_pool.py \--out data/rollouts/rc1\_seed.jsonl \--n 30000 \\  
  \--mix "hotpotqa:0.45,strategyqa:0.30,gsm8k:0.25" \\  
  \--max\_turns 6 \--clarify\_rate 0.35 \--tools "wiki,calc" \\  
  \--templates\_dir templates/pack\_v2 \--min\_tool\_hops 3 \--ops\_numeric\_min 3 \\  
  \--role\_style\_balanced \--distinct\_prompts

python scripts/validate\_pool.py data/rollouts/rc1\_seed.jsonl \\  
  \--min\_distinct2 0.60 \--kl3\_min 0.15 \--roles\_min 4 \--styles\_min 3 \\  
  \--max\_dup\_pct 2.0 \--leak\_check data/shadow\_eval\_245.jsonl \\  
  \--leak\_ngram 5 \--leak\_sim 0.85 \\  
  \> reports/rc1/diversity\_report.txt

python scripts/difficulty\_metrics.py \\  
  \--in data/rollouts/rc1\_seed.jsonl \--out data/rollouts/rc1\_seed.metrics.jsonl

python scripts/difficulty\_bucketize.py \\  
  \--metrics data/rollouts/rc1\_seed.metrics.jsonl \\  
  \--target "easy:0.25,medium:0.45,hard:0.30" \\  
  \--by\_task "hotpotqa,strategyqa,gsm8k" \\  
  \--out data/rollouts/rc1\_seed.balanced.jsonl

python scripts/validate\_difficulty.py \\  
  \--metrics data/rollouts/rc1\_seed.metrics.jsonl \\  
  \--balanced data/rollouts/rc1\_seed.balanced.jsonl \\  
  \--min\_hard\_pct 0.30 \--max\_easy\_pct 0.30 \\  
  \--len\_max 3500 \--turns\_max 8 \--tool\_hops\_max 8 \\  
  \--clue\_overlap\_max\_easy 0.65 \--clue\_overlap\_min\_hard 0.10 \\  
  \--out reports/rc1/difficulty\_report.json

**D. RC 闸门（复跑影子 \+ 自动判定）**

python \-m src.evaluation.shadow\_run \--n 245 \--seed 20250820 \--stratify \--tag "pre\_run\_check\_2"

python scripts/auto\_round2\_check.py \\  
  \--spearman-min 0.75 \--top10-min 0.70 \--corr-improve-pct-min 0.10 \\  
  \--in reports/rc1 \--out reports/preflight/round2\_pass.json

**E. 训练 2k 验证 \+ 推送（HF 全量 / GitHub 轻量）**

python \-m train.ppo\_trial \--config configs/ppo\_trial.yaml \\  
  \--override "base\_model=Qwen/Qwen3-4B-Thinking-2507,use\_overclar\_penalty=true,steps=2000,max\_concurrent=2"

\# 自动推送单元（Notebook 已有）：确保 env GITHUB\_REPO/HF\_TOKEN/GIT\_TOKEN 已设

---

下面这段是**给 Cursor 的新增联调指令**（独立附加）。你把它和上一版一起发给他即可。

---

# **【Gemini 通道联调指令（附加）】**

目的：你在**本地**已配置好真实 `GEMINI_API_KEY`。请严格按以下步骤，**一次性验证所有依赖 Gemini 的路径**（探针、反模拟、打分账本、并发退让、缓存命中、影子评估、小规模生成/评分路由、硬性禁用其他 provider）。任一步失败必须**立即停止**并回报。

## **0\) 环境硬约束（全程生效）**

set \-euo pipefail  
export RUN\_MODE=prod  
export SCORER\_PROVIDER=gemini  
\# 必须有真实 Key  
test \-n "${GEMINI\_API\_KEY:-}" || (echo "❌ 缺少 GEMINI\_API\_KEY" && exit 1\)

## **1\) 连通性与计费探针（必须产生“计费+时延”）**

rm \-f reports/rc1/scoring\_ledger.jsonl || true  
python scripts/probe\_scorer.py \--n 8 \--provider gemini \--live  
python scripts/assert\_not\_simulated.py \--cache\_hit\_lt 0.90

**验收点**：`reports/rc1/scoring_ledger.jsonl` 至少 8 条，字段包含 `billable_tokens>0`、`latency_ms>0`、`cache_hit` 有 True/False 混合。

## **2\) 并发与 429 退让（速率保护是否生效）**

\# 临时放宽并发到 8，触发退让逻辑  
python \-m src.evaluation.shadow\_run \--n 96 \--seed 20250821 \--stratify \--tag "gemini\_rate\_test" \--max\_concurrent 8

**验收点**：无崩溃；账本中能看到多条记录，且整体可完成。若有 429，应看到重试后成功的记录（status=ok）。

## **3\) 缓存语义（命中率与 TTL）**

\# 对同一批输入重复评分，命中率应显著上升  
python scripts/probe\_scorer.py \--n 8 \--provider gemini \--live  
python scripts/assert\_not\_simulated.py \--cache\_hit\_lt 0.50   \# 此次重复调用，允许更高命中率

**验收点**：第二轮后账本中 `cache_hit:true` 占比明显提高；仍需有若干非命中记录（避免“全缓存假活”）。

## **4\) 硬禁用其他 provider（负向用例必须 fail）**

( SCORER\_PROVIDER=deepseek\_r1 python scripts/probe\_scorer.py \--n 1 \--provider deepseek\_r1 \--live ) && \\  
  ( echo "❌ 不应允许切 provider" && exit 1 ) || echo "✅ 非 gemini 分支已被硬拒绝"

## **5\) 影子评估最小闭环（数值产出）**

rm \-f data/shadow\_eval\_245.jsonl || true  
python \-m src.evaluation.shadow\_run \--n 245 \--seed 20250821 \--stratify \\  
  \--materialize data/shadow\_eval\_245.jsonl \\  
  \--dump-manifest reports/rc1/sample\_manifest.json

python scripts/pre\_run\_check.py \--shadow data/shadow\_eval\_245.jsonl \\  
  \--spearman-min 0.55 \--top10-min 0.60

**验收点**：预检脚本**零错误退出**，并在报告目录中可追溯 `spearman/top10` 的**实际数值**。

## **6\) 模板/多样性快速抽检（必须看到数值）**

python scripts/validate\_pool.py data/rollouts/rc1\_seed.jsonl \\  
  \--min\_distinct2 0.60 \--kl3\_min 0.15 \--roles\_min 4 \--styles\_min 3 \\  
  \--max\_dup\_pct 2.0 \--dry\_run\_only \> reports/rc1/template\_diversity\_check.txt

**验收点**：`template_diversity_check.txt` 内含 `distinct-2` 与 `3-gram KL` 的**实测分数**，均达标。

## **7\) 生成/评分路由烟测（如果代码中存在生成调用）**

\# 若有 src/generation/\* 走 Gemini，请执行一次 16 样本的小烟测  
python \-m src.generation.smoke \--n 16 \--provider gemini \--max\_concurrent 4

**验收点**：无异常退出；账本新增记录；生成路径与评分路径可以同时写账本（若分文件，需同时存在）。

## **8\) 健康度汇总（自动生成一份 JSON 摘要）**

python \- \<\<'PY'  
import json, statistics, time  
fn="reports/rc1/scoring\_ledger.jsonl"  
rows=\[json.loads(l) for l in open(fn)\]  
lat=\[r.get("latency\_ms") or 0 for r in rows if r.get("latency\_ms") is not None\]  
bill=\[r.get("billable\_tokens") or 0 for r in rows\]  
out={  
 "ts": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime()),  
 "total\_calls": len(rows),  
 "ok\_calls": sum(1 for r in rows if r.get("status")=="ok"),  
 "uncached\_calls": sum(1 for r in rows if not r.get("cache\_hit", False)),  
 "p50\_latency\_ms": statistics.median(lat) if lat else None,  
 "p95\_latency\_ms": (sorted(lat)\[int(0.95\*len(lat))-1\] if lat else None),  
 "zero\_billable": sum(1 for b in bill if b==0),  
}  
print(json.dumps(out, indent=2, ensure\_ascii=False))  
open("reports/rc1/gemini\_health.json","w").write(json.dumps(out,indent=2,ensure\_ascii=False))  
PY

**验收点**：`reports/rc1/gemini_health.json` 生成，字段完整；`zero_billable` 应为 0 或极小值。

## **9\) 交付给 PM 的证据（把以下输出粘贴回去）**

echo "\#1 探针/反模拟通过" && tail \-n 5 reports/rc1/scoring\_ledger.jsonl  
echo "\#2 速率退让完成，总调用条数：" && wc \-l reports/rc1/scoring\_ledger.jsonl  
echo "\#3 模板多样性（数值）" && sed \-n '1,80p' reports/rc1/template\_diversity\_check.txt  
echo "\#4 影子评估阈值" && grep \-R "spearman" \-n reports/rc1 | tail \-n 3 && grep \-R "top10" \-n reports/rc1 | tail \-n 3  
echo "\#5 Gemini 健康摘要" && sed \-n '1,200p' reports/rc1/gemini\_health.json

规则再强调一次：**任一步不达标，立即停止**，不要“演示式继续跑”。把失败的命令输出、最后 50 行日志、以及 `reports/rc1/scoring_ledger.jsonl` 最末 20 行一并贴回给 PM/总工定位。

# **提交给 PM 的“证据包”（把以下命令的输出粘回来）**

\# 1\) 闸门账本：计费&时延统计  
python \- \<\<'PY'  
import json,statistics,sys  
fn="reports/rc1/scoring\_ledger.jsonl"  
ok=0; lat=\[\]; miss=0; uncached=0  
for line in open(fn):  
    j=json.loads(line)  
    ok+= (j.get("status")=="ok")  
    lat.append(j.get("latency\_ms") or 0\)  
    uncached+= (not j.get("cache\_hit",False))  
    miss+= (j.get("billable\_tokens") in \[None,0\])  
print("ledger ok:",ok,"uncached:",uncached,"miss\_billable:",miss,"lat\_p50:",statistics.median(lat))  
PY

\# 2\) 模板多样性（数值）  
sed \-n '1,80p' reports/rc1/diversity\_report.txt

\# 3\) 难度报告摘要  
sed \-n '1,120p' reports/rc1/difficulty\_report.json

\# 4\) 影子评估阈值  
grep \-R "spearman" \-n reports/rc1 | tail \-n 5  
grep \-R "top10" \-n reports/rc1 | tail \-n 5

\# 5\) 推送确认（最新 tag）  
echo "HF latest:" && python \- \<\<'PY'  
from huggingface\_hub import HfApi; api=HfApi()  
revs=\[r.rfilename for r in api.list\_repo\_files("Atomheart-Father/rc1-qwen3-4b-thinking-gemini")\]  
print(sorted(\[p for p in revs if p.startswith("checkpoint-")\])\[-3:\])  
PY  
echo "GH release (expect rc1-steps-XXXX)" && curl \-s \-H "Authorization: token $GIT\_TOKEN" https://api.github.com/repos/$GITHUB\_REPO/releases | jq \-r '.\[0\].tag\_name,.\[0\].assets\[\].name'

---

# **小结（给 Cursor）**

* **不许**再“演示性继续跑”。所有预检/闸门**失败即停**。  
* 用 **真实 GEMINI Key** 通过探针与反模拟后，再做影子与难度、再训练。  
* **GITHUB\_REPO** 由 PM 指定后写入环境；否则视作配置错误。  
* 所有报告必须包含**数值证据**（distinct-2、KL、spearman、top10、corr\_improve）。

PM 这边只需要把 **`GITHUB_REPO` 的完整路径**（org/repo）发我；其余我和 Cursor按上面清单执行到底。

