---

# **给 Cursor 的 RC1 执行指令（一次性完整清单）**

目标：在 **Colab** 上以 **Gemini 单提供方** 跑通“闸门→影子评估→难度分桶→小步训练→断点续训”，  
并将 **完整 checkpoint 推送到 HF（公有）**，**轻量资产推送到 GitHub Releases**。  
在闸门未通过前**严禁**进入训练。

---

## **0\) 目录与配置（立即执行）**

**0.1 目录结构（若不存在则创建）**

mkdir \-p scripts train src/evaluation templates/pack\_v2 reports/preflight reports/rc1 data/rollouts checkpoints/rc1

**0.2 固定运行配置（写入 `configs/runtime.rc1.yaml`）**

run\_mode: prod  
scorer\_provider: gemini  
dataset\_mix: "hotpotqa:0.45,strategyqa:0.30,gsm8k:0.25"  
precheck\_thresholds:  
  spearman\_min: 0.55  
  top10\_min: 0.60  
rc\_gate:  
  spearman\_min: 0.75  
  top10\_min: 0.70  
  corr\_improve\_pct\_min: 0.10  
overclar\_penalty:  
  enabled: true  
  alpha: 0.07  
  cap: 3  
difficulty\_target: "easy:0.25,medium:0.45,hard:0.30"  
save\_steps: 500  
checkpoint\_keep: 4  
max\_concurrent: 2  
cache\_ttl\_days: 14  
scoring\_k: 3

**0.3 仅当 `SCORER_PROVIDER=gemini` 时，强制禁用其它分支**  
在评分/生成入口（如 `src/scoring/provider_router.py`）加：

import os  
if os.getenv("SCORER\_PROVIDER","").lower() \!= "gemini":  
    raise RuntimeError("RC1 仅允许 SCORER\_PROVIDER=gemini")

并把其它 provider 的调用路径前置 `raise`/`assert False`（不可到达）。

---

## **1\) 闸门与账本（必须先打通）**

**1.1 评分账本（追加写 `reports/rc1/scoring_ledger.jsonl`）**  
在调用评分返回处追加：

from datetime import datetime  
import json, os

os.makedirs("reports/rc1", exist\_ok=True)  
rec \= {  
  "ts": datetime.utcnow().isoformat()+"Z",  
  "provider": "gemini",  
  "billable\_tokens": metrics.get("billable\_tokens", None),  
  "latency\_ms": metrics.get("latency\_ms", None),  
  "status": metrics.get("status", "ok"),  
  "cache\_hit": bool(metrics.get("cache\_hit", False)),  
  "request\_id": metrics.get("request\_id", None)  
}  
with open("reports/rc1/scoring\_ledger.jsonl","a") as f:  
    f.write(json.dumps(rec, ensure\_ascii=False)+"\\n")

**1.2 防伪闸门（两步都要 PASS）**

\# 必须出现 billable 与非零 latency，且缓存命中率 \< 0.90  
python scripts/probe\_scorer.py \--n 6 \--provider gemini \--live  
python scripts/assert\_not\_simulated.py \--cache\_hit\_lt 0.90

两步任一步失败：**立即停止**，不得进入后续流程。

---

## **2\) 影子评估与难度分桶（预检 → RC 闸门）**

**2.1 固化影子集 \+ 预检**

python \-m src.evaluation.shadow\_run \--n 245 \--seed 20250820 \--stratify \\  
  \--materialize data/shadow\_eval\_245.jsonl \\  
  \--dump-manifest reports/rc1/sample\_manifest.json

python scripts/pre\_run\_check.py \\  
  \--shadow data/shadow\_eval\_245.jsonl \\  
  \--spearman-min 0.55 \--top10-min 0.60  \# 未达标非0退出

**2.2 构建 30k 种子池 \+ 多样性校验 \+ 难度度量/分桶**

python scripts/build\_rollout\_pool.py \--out data/rollouts/rc1\_seed.jsonl \--n 30000 \\  
  \--mix "hotpotqa:0.45,strategyqa:0.30,gsm8k:0.25" \\  
  \--max\_turns 6 \--clarify\_rate 0.35 \--tools "wiki,calc" \\  
  \--templates\_dir templates/pack\_v2 \--min\_tool\_hops 3 \--ops\_numeric\_min 3 \\  
  \--role\_style\_balanced true

python scripts/validate\_pool.py data/rollouts/rc1\_seed.jsonl \\  
  \--min\_distinct2 0.60 \--kl3\_min 0.15 \--roles\_min 4 \--styles\_min 3 \\  
  \--max\_dup\_pct 2.0 \--leak\_check data/shadow\_eval\_245.jsonl \\  
  \--leak\_ngram 5 \--leak\_sim 0.85

python scripts/difficulty\_metrics.py \\  
  \--in data/rollouts/rc1\_seed.jsonl \--out data/rollouts/rc1\_seed.metrics.jsonl

python scripts/difficulty\_bucketize.py \\  
  \--metrics data/rollouts/rc1\_seed.metrics.jsonl \\  
  \--target "easy:0.25,medium:0.45,hard:0.30" \\  
  \--by\_task "hotpotqa,strategyqa,gsm8k" \\  
  \--out data/rollouts/rc1\_seed.balanced.jsonl

python scripts/validate\_difficulty.py \\  
  \--metrics data/rollouts/rc1\_seed.metrics.jsonl \\  
  \--balanced data/rollouts/rc1\_seed.balanced.jsonl \\  
  \--min\_hard\_pct 0.30 \--max\_easy\_pct 0.30 \\  
  \--len\_max 3500 \--turns\_max 8 \--tool\_hops\_max 8 \\  
  \--clue\_overlap\_max\_easy 0.65 \--clue\_overlap\_min\_hard 0.10 \\  
  \--out reports/rc1/difficulty\_report.json

**2.3 RC 闸门（影子复跑 \+ Round2 自动判定）**

python \-m src.evaluation.shadow\_run \--n 245 \--seed 20250820 \--stratify \--tag "pre\_run\_check\_2"

python scripts/auto\_round2\_check.py \\  
  \--spearman-min 0.75 \--top10-min 0.70 \--corr-improve-pct-min 0.10 \\  
  \--in reports/rc1 \--out reports/preflight/round2\_pass.json

未生成 `round2_pass.json` 或内容显示未通过：**不得训练**。

---

## **3\) Colab 笔记本必备单元（粘贴/更新）**

**3.1 读取 Secrets**

from google.colab import userdata  
import os  
os.environ\["GEMINI\_API\_KEY"\] \= userdata.get("GEMINI\_API\_KEY") or ""  
os.environ\["HF\_TOKEN"\]       \= userdata.get("HF\_TOKEN") or ""  
os.environ\["GIT\_TOKEN"\]      \= userdata.get("GIT\_TOKEN") or ""  
os.environ\["RUN\_MODE"\]       \= "prod"  
os.environ\["SCORER\_PROVIDER"\]= "gemini"

**3.2 自动续训启动器**

import os, glob, json, subprocess, shutil, pathlib, requests, time  
from huggingface\_hub import HfApi, HfFolder, create\_repo, upload\_folder

HF\_REPO\_ID \= "Atomheart-Father/rc1-qwen3-4b-thinking-gemini"  \# 固定公有仓  
HfFolder.save\_token(os.environ\["HF\_TOKEN"\])  
api \= HfApi()  
try:  
    create\_repo(HF\_REPO\_ID, private=False, exist\_ok=True, token=os.environ\["HF\_TOKEN"\])  
except Exception as e:  
    print("HF repo ensured:", e)

def resume\_path():  
    cp \= sorted(glob.glob("checkpoints/rc1/checkpoint-\*"), key=lambda p: int(p.split("-")\[-1\]))  
    return cp\[-1\] if cp else None

RESUME \= resume\_path()  
EXTRA \= \[\] if RESUME is None else \[f"--resume\_from\_checkpoint={RESUME}"\]  
print("RESUME:", RESUME)

**3.3 训练入口（闸门文件 \+ 配置通过才允许）**

import json, sys, os, pathlib  
pre \= pathlib.Path("reports/preflight/round2\_pass.json")  
if not pre.exists():  
    raise SystemExit("❌ RC gate not passed. Aborting training.")  
if os.system("python scripts/assert\_not\_simulated.py \--cache\_hit\_lt 0.90") \!= 0:  
    raise SystemExit("❌ Anti-simulation failed.")

\!python \-m train.ppo\_trial \--config configs/ppo\_trial.yaml \\  
  \--override "base\_model=Qwen/Qwen3-4B-Thinking-2507,use\_overclar\_penalty=true,steps=2000,max\_concurrent=2"

**3.4 推送脚本（HF 全量 \+ GitHub Releases 轻量）**

import os, json, glob, zipfile, requests, pathlib, shutil  
from huggingface\_hub import HfApi, upload\_folder

HF\_REPO\_ID \= "Atomheart-Father/rc1-qwen3-4b-thinking-gemini"  
api \= HfApi()

def push\_hf(full\_dir, tag):  
    api.upload\_folder(  
        folder\_path=full\_dir, repo\_id=HF\_REPO\_ID, path\_in\_repo=f"{tag}",  
        repo\_type="model", token=os.environ\["HF\_TOKEN"\]  
    )

def zip\_and\_push\_github(light\_files, tag, body=""):  
    owner\_repo \= os.environ.get("GITHUB\_REPO","owner/repo")  \# 由代码仓设置 env  
    token \= os.environ\["GIT\_TOKEN"\]  
    \# 1\) 创建 release  
    r \= requests.post(  
      f"https://api.github.com/repos/{owner\_repo}/releases",  
      headers={"Authorization": f"token {token}"},  
      json={"tag\_name": tag, "name": tag, "body": body, "draft": False, "prerelease": False}  
    )  
    r.raise\_for\_status()  
    upload\_url \= r.json()\["upload\_url"\].split("{")\[0\]

    \# 2\) 打包轻量资产  
    zname \= f"{tag}-light.zip"  
    with zipfile.ZipFile(zname, "w", zipfile.ZIP\_DEFLATED) as zf:  
        for p in light\_files:  
            zf.write(p, arcname=os.path.basename(p))

    \# 3\) 上传资产  
    with open(zname, "rb") as f:  
        rr \= requests.post(  
          f"{upload\_url}?name={zname}",  
          headers={"Authorization": f"token {token}", "Content-Type":"application/zip"},  
          data=f.read()  
        )  
        rr.raise\_for\_status()  
    print("✅ GitHub release asset uploaded:", zname)

def export\_and\_push():  
    \# 选最新 checkpoint 目录  
    cps \= sorted(glob.glob("checkpoints/rc1/checkpoint-\*"), key=lambda p: int(p.split("-")\[-1\]))  
    assert cps, "no checkpoints found"  
    last \= cps\[-1\]  
    step \= last.split("-")\[-1\]  
    tag \= f"rc1-steps-{step}"

    \# HF：推送完整目录（包含 optimizer/scheduler/accelerate state 等）  
    push\_hf(last, tag)

    \# GitHub：仅推轻量资产（适配器 \+ 运行摘要）  
    light \= \[\]  
    for fn in \["adapter\_model.safetensors","adapter\_config.json","run\_state.json","reports/rc1/sample\_manifest.json"\]:  
        p \= os.path.join(last, fn) if not os.path.exists(fn) else fn  
        if os.path.exists(p): light.append(p)  
    zip\_and\_push\_github(light, tag, body="LÓRA adapter \+ run\_state")

export\_and\_push()

约定：Colab 每到 `save_steps` 自动执行“**先 HF 后 GitHub**”的推送单元。HF 成功即可；GitHub 若失败记录错误并继续训练（不得中断训练）。

---

## **4\) 模板与多样性（一次性完成并自测）**

* `templates/pack_v2/` 下每类 **≥ 6** 模板，角色 **≥ 4**，语体 **≥ 3**；  
* 跑 `python scripts/validate_pool.py ...` 确认 `distinct-2≥0.60`、`3-gram KL≥0.15`；  
* 任何失败，**修模板再测**，不得降低阈值。

---

## **5\) GitHub Actions（只做预检，禁长训）**

在代码仓新建 `.github/workflows/rc1_preflight.yml`：

name: rc1-preflight  
on:  
  workflow\_dispatch:  
  push:  
    paths:  
      \- "scripts/\*\*"  
      \- "src/\*\*"  
      \- "configs/runtime.rc1.yaml"  
jobs:  
  preflight:  
    runs-on: ubuntu-latest  
    env:  
      RUN\_MODE: prod  
      SCORER\_PROVIDER: gemini  
      GEMINI\_API\_KEY: ${{ secrets.GEMINI\_API\_KEY }}  
    steps:  
      \- uses: actions/checkout@v4  
      \- uses: actions/setup-python@v5  
        with: { python-version: "3.11" }  
      \- run: pip install \-U "transformers\>=4.43" datasets nltk  
      \- run: python scripts/probe\_scorer.py \--n 3 \--provider gemini \--live  
      \- run: python scripts/assert\_not\_simulated.py \--cache\_hit\_lt 0.90  
      \- run: python \-m src.evaluation.shadow\_run \--n 64 \--seed 20250820 \--stratify \--tag "ci\_preflight"  
      \- run: python scripts/pre\_run\_check.py \--shadow data/shadow\_eval\_245.jsonl \--spearman-min 0.55 \--top10-min 0.60 || true

CI 仅用于**轻量预检**；严禁训练；Secrets 只注入 `GEMINI_API_KEY`。

---

## **6\) 交付与验收（你按此自验）**

*  `reports/rc1/scoring_ledger.jsonl` 持续产生日志，含 billable/latency/cache\_hit。  
*  `reports/preflight/round1.json` \+ `round2_pass.json` 由脚本生成（非手填）。  
*  `reports/rc1/difficulty_report.json` 达标（Hard 桶≥30%，并后续 RC 报告中 Hard 成功率提升 ≥ \+5pp）。  
*  Colab 中 **训练入口** 会在闸门未过时报错退出。  
*  HF Hub：`Atomheart-Father/rc1-qwen3-4b-thinking-gemini` 可见最新 `checkpoint-*` 目录；  
*  GitHub Releases：存在 `rc1-steps-{N}` 标签的 **轻量包**（zip）。  
*  24h 重启后，自动 **resume** 成功（无需手工指定路径）。

---

### **备注（你必须遵守）**

* 未通过 **防伪闸门** 与 **影子阈值** → **不可训练**。  
* 不允许改动阈值、关闭账本或切换 provider。  
* 任何失败先读报错与日志；**禁止**拍脑袋修代码；必要时仅调整模板内容后重跑校验。

——以上。请严格按此单执行，完成后把 6\) 的验收项逐条勾给 PM。

