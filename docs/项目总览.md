——— ✂️ 发给 Cursor ——

# **📚 项目总览（一定要先读）**

## **我们在做什么**

* **目标**：训练一个“主动澄清再解题”的深度推理模型。遇到信息缺口要**先问**（`<ASK>`）而不是臆测；信息充分后**再答**（`<FINAL>`）。  
* **研究导向**：**数据、策略、论文**是核心；代码是工具。我们要可追溯的数据谱系、清晰的奖励/策略实验、扎实的评测与消融。  
* **输出节奏**：**Micro-batch → 放量**。先跑 10 条验证，通过再 1k；每天尽量吃满 **3 把 Gemini 免费配额**，DeepSeek 用在最“值钱”的环节（RSD & 仲裁）。

## **当前阶段（WBS）**

* **WBS 阶段 1：数据/运行基础设施**（你正承接此阶段）。  
* **严禁私改 WBS**。如需调整字段/目录/里程碑，**先开《WBS-变更提案》Issue**，获批再改。

---

# **🛠️ 工作方式（我们怎么协作）**

## **小步快跑 \+ Peer Review**

* **一次只做一件事**：每个 PR 解决一个明确目标（如“10 条微批 \+ 报表四件套”）。  
* **强制 Review**：我会逐行审核，专查三类风险：**模拟/造假**、**硬编码投机**、**Schema 走样**。  
* **DoR/DoD**  
  * **Definition of Ready**：目标清晰、输入明确（`.env`、路由、阈值、产物清单）。  
  * **Definition of Done**：脚本一键跑通、报表齐全、抽检样本合格、**无模拟**、**无泄漏**。

## **沟通与升级（遇到难题及时上报）**

* **立即上报**的场景：API 限额/系统性 5xx、解析器不兼容、成本异常、重复率/Distinct-2 不过线、`model_target` 被污染（礼貌语或 CoT 泄漏）。  
* 上报内容：**错误类型 \+ 最小复现实例 \+ 你已尝试的两种替代方案**（例如路由 Fail-Over、参数替换）。  
* 禁止“投机取巧”绕过闸门：失败就失败（**Fail Closed**），**不**用假数据补位、**不**降级成本地伪造。

---

# **🔒 红线与风控（务必严格遵守）**

## **禁止“模拟/造假”**

* 不允许占位样本、随机文本、假日志、假训练“桩”（例如伪 PPO、伪评审）。  
* 不允许硬规则“对指标”（例如“遇到关键词就强行 `<ASK>`”）写入数据或 Loader。

## **思维链安全**

* 训练/评测可用私有 `<think>…</think>`，**默认不写入对话历史**。  
* **`model_target` 只允许一个控制符**：`<ASK>…</ASK>` 或 `<FINAL>…</FINAL>`；**不得**夹带礼貌语/解释/思维文本。  
* 任何 CoT/礼貌语混入 `model_target` 或历史 → **一票否决**。

## **密钥与合规**

* **只读 `.env`**：严禁硬编码密钥/模型名；日志只显示末 4 位。  
* 数据不得包含 PII/版权文本；来源/提示 **哈希化**，不落原文；所有调用写入 `provenance.jsonl`。

---

# **🧭 环境与路由（多模型，多 Key）**

## **`.env`（只读）**

* `GEMINI_API_KEY / GEMINI_API_KEY2 / GEMINI_API_KEY3`  
* `DeepSeek_API_KEY / DeepSeek_API_KEY2`（chat / reasoner）  
* `HF_TOKEN / GIT_TOKEN / MODEL_NAME`（本地评审 Qwen3-4B-Thinking）  
* 可选：`DATA_DATE / TARGET_ALC / TARGET_AR / TARGET_RSD / FAILOVER_ENABLE / ALLOW_RSD_FALLBACK / MAX_CALLS_DS_*`

## **任务路由（含 Fail-Over）**

* **ALC 生成**：`gemini-2.5-flash → gemini-2.5-flash-lite → deepseek-chat`  
* **AR 生成**：`gemini-2.5-pro → deepseek-reasoner`  
* **RSD 生成**：`deepseek-reasoner`（默认无下探；除非 `ALLOW_RSD_FALLBACK=true`，仍只抽动作/时机）  
* **评审**：`gemini-2.5-pro + 本地 Qwen` 并行；**仅冲突样本**升级 `deepseek-chat` 仲裁。  
* 429/限额/5xx → 自动切下一跳（**指数退避 \+ 抖动**）；在 `provenance.failover` 记录 `{from,to,reason_code,ts}`；在 `cost_and_quota.md` 记录各 Key 触顶时间与 DeepSeek 调用/估算成本。  
* 成本策略：**优先用免费 Gemini**；DeepSeek 只用于 **RSD+仲裁**。

---

# **📦 数据标准（Schema v1.1 摘要）**

## **结构**

* `turns[]`：`{role∈{user, model_target, assistant}, text}`；**首个助手回合必须是 `model_target`**。  
* `model_target`：只允许 **一个** 控制符：`<ASK>…</ASK>` 或 `<FINAL>…</FINAL>`（正则 `^\s*<(ASK|FINAL)>.+?</\1>\s*$`）。  
* `labels`：`ask_required`、`ambiguity_types[]`、`good_question_set[] (≤3)`、`minimal_clarifications ∈ {1,2}`；AR 额外 `oracle_answer`。  
* `reasoning.actions[]`：至少包含 `AWARE_GAP, ASK, STOP_ASK, FINALIZE`（RSD 还可含 `DERIVE, VERIFY`）。  
* `source∈{synthetic-gemini, r1-distill, curated, human}`。

## **反模板与多样性**

* \*\*三套生成配方（Recipe-A/B/C）\*\*同时在批次中使用，并把 `recipe` 记入 `provenance`。  
* 同批 `<ASK>` 句式 **Distinct-2 ≥ 0.85**；相似度\>0.9 用 *flash-lite* 做**句式改写**（不改缺口变量）。  
* **去重阈值**：ALC 0.90 / AR 0.95 / RSD 0.88（分域统计与淘汰原因写入报告）。

---

# **✅ 质量闸门与指标（过关才允许放量）**

* **硬红线**：ASK 触发率 ≥95%；**CoT 泄漏 \= 0**；重复率 \<8%；`model_target` 正则通过；无空 `turns`。  
* **ALC**：Over-asking ≤10%。  
* **AR（若由 flash 生成）**：Clarification-F1 ≥0.7 且 InfoGain ≥0.8。  
* **评审**：Mixture-of-Judges（Gemini \+ Qwen）；只对冲突样本升至 DeepSeek 仲裁。  
* **报表四件套 \+ 成本**：  
  * `generation_summary.md`（含各 **recipe** 占比与新增条数）  
  * `quality_review_report.md`（Gemini vs Qwen 一致性、冲突/仲裁清单、ASK Distinct-2、Over-asking、InfoGain@1）  
  * `deduplication_report.md`（分域+分 recipe）  
  * `data_overview.md`  
  * `cost_and_quota.md`（Key 触顶时间、failover 次数、DeepSeek 调用/估算费用）  
  * `provenance.jsonl`（追加式，字段：`provider, model, key_index, temperature, seed, generator_prompt_hash, judge_prompt_hash, time, domain, language, recipe, dedup_score, quality_score, judge_votes, failover?` 等）

---

# **🧾 PR 规范（必须遵守）**

* **命名**：`feat/data-<microbatch|1k>-<date>-<topic>`  
* **描述必填**：WBS 对齐、是否触发 Fail-Over（次数/原因码/路由）、质量指标（ASK/Distinct-2/Over-asking/InfoGain/重复率）、抽检 5 条（ALC/AR/RSD 各≥1）、`provenance` 字段齐全。  
* **禁止**：引入训练/奖励桩代码、绕过质量闸门、提交含密钥的日志或配置。  
* **失败即失败**：任何闸门不过 → PR 标注 **blocked** 并给出“修复计划 \+ 复现方式”，**不**允许用假数据补量。

---

# **🆘 如果遇到阻塞（Checklist）**

* 是限额/429？→ 启动 **Fail-Over** 路由 \+ 记录 `provenance.failover`。  
* 是模板化/相似度过高？→ 启用 **flash-lite 句式改写** \+ 增加人设/场景池采样。  
* 是结构问题（空 `turns` / 礼貌语污染）？→ 启动**硬闸**（正则/完整性检查）并重生。  
* 是成本暴涨？→ 限制 `MAX_CALLS_DS_*`，只对冲突样本仲裁；其余延后。  
* 不确定？→ 立刻上报“问题类型 \+ 最小复现 \+ 两个备选方案”。

---

**总之**：先 10 条合格 → 我口头放行 1k；所有内容**真实、可审计、可复现**。  
你照此执行就行；其余实现细节你自由发挥，我只看产物与指标。

——— ✂️ 复制结束 ——

