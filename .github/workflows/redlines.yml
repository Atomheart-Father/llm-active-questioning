name: redlines
on:
  push:
  pull_request:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1) 根目录必须干净
      - name: Root must be clean
        shell: bash
        run: |
          set -euo pipefail
          if ls -1 | egrep -q '^(gemini_cache\.sqlite|gemini_integration\.py)$'; then
            echo "❌ Root polluted by Gemini files"
            exit 1
          fi
          echo "✅ Root clean"

      # 2) 主回路禁止外部 LLM 导入（豁免 integrations/ 与 data/，只扫 .py）
      - name: Ban external LLM imports in main loop
        shell: bash
        run: |
          set -euo pipefail
          if grep -RInE 'google\.generativeai|openai|anthropic' \
               --include='*.py' \
               --exclude-dir=integrations --exclude-dir=.git --exclude-dir=data \
               src/ tools/ train/ 2>/dev/null; then
            echo "❌ Found forbidden imports in main loop"
            exit 1
          fi
          echo "✅ No forbidden imports in main loop"
